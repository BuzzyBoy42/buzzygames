<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Play ‚Ä¢ Buzzy Games</title>
<meta name="theme-color" content="#0a0a0a" />
<style>
  :root{ --bg:#0a0a0a; --bar:#101010; --border:rgba(255,255,255,.1); --text:#f5f5f5; --muted:#cfcfcf; --accent:#ff7a18; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .bar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(180deg,var(--bar),#0c0c0c);border-bottom:1px solid var(--border)}
  .btn{background:#111;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border:0;color:#000;font-weight:900}
  .spacer{flex:1}
  .title{font-weight:900;letter-spacing:.2px}
  .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  iframe{display:block;width:100%;height:calc(100vh - 52px);border:0;background:#0c0c0c}
</style>
</head>
<body>
  <div class="bar">
    <button class="btn" id="backBtn">‚Üê Back</button>
    <div class="title" id="gameTitle">Loading‚Ä¶</div>
    <div class="spacer"></div>
    <div class="pill" title="Players currently in this game">üë• <span id="nowCount">0</span> Playing</div>
    <!-- Removed the "Open" button per your request -->
    <button class="btn primary" id="shareBtn" title="Copy share link">Share</button>
  </div>
  <iframe id="frame" sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-popups allow-popups-to-escape-sandbox" referrerpolicy="no-referrer"></iframe>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import {
    getFirestore, doc, getDoc, updateDoc, serverTimestamp, increment
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import {
    getDatabase, ref as dref, onValue, onDisconnect, set as dset, remove as dremove
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBI7amPbyDP4cgtWvoooGz9JQAPXJEpCaE",
    authDomain: "buzzy-games.firebaseapp.com",
    projectId: "buzzy-games",
    storageBucket: "buzzy-games.firebasestorage.app",
    messagingSenderId: "1019717198169",
    appId: "1:1019717198169:web:8bff09527755e2672c6c48",
    measurementId: "G-JPPBF2PHDJ",
    databaseURL: "https://buzzy-games-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){}
  const db = getFirestore(app);
  const rtdb = getDatabase(app);

  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);
  const gameId = params.get('id');
  if(!gameId){ alert('Missing game id'); }

  // Load game meta, set iframe, bump plays once
  const gRef = doc(db,'games', gameId);
  const gSnap = await getDoc(gRef);
  if(gSnap.exists()){
    const g = gSnap.data();
    $('#gameTitle').textContent = g.name || 'Untitled';
    $('#frame').src = g.gameUrl;
    $('#shareBtn').addEventListener('click', async ()=>{
      const url = `${location.origin}${location.pathname}?id=${gameId}`;
      try{ await navigator.clipboard.writeText(url); alert('Share link copied!'); } catch{ prompt('Copy link:', url); }
    });
    try { await updateDoc(gRef, { plays: increment(1), lastPlayedAt: serverTimestamp() }); } catch(e){}
  } else {
    $('#gameTitle').textContent = 'Game not found';
  }

  // SITE presence entry (for global online)
  const sitePageId = (crypto.randomUUID?.() || ('page_'+Math.random().toString(36).slice(2)));
  const siteRef = dref(rtdb, `presence/site/${sitePageId}`);
  dset(siteRef, true);
  onDisconnect(siteRef).remove();

  // GAME presence entry (accurate concurrent players)
  const gamePageId = (crypto.randomUUID?.() || ('page_'+Math.random().toString(36).slice(2)));
  const gameRef = dref(rtdb, `presence/game/${gameId}/${gamePageId}`);
  dset(gameRef, true);
  onDisconnect(gameRef).remove();

  // Live "Playing" count by counting children under presence/game/{gameId}
  onValue(dref(rtdb, `presence/game/${gameId}`), snap=>{
    const val = snap.val() || {};
    const count = Object.keys(val).length;
    $('#nowCount').textContent = count;
  });

  // UI
  $('#backBtn').addEventListener('click', ()=> {
    if(document.referrer && document.referrer.includes(location.host)) history.back();
    else location.href = 'index.html';
  });
</script>
</body>
</html>
