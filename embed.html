<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Play ‚Ä¢ Buzzy Games</title>
<meta name="theme-color" content="#0a0a0a" />
<style>
  :root{ --bg:#0a0a0a; --bar:#101010; --border:rgba(255,255,255,.1); --text:#f5f5f5; --muted:#cfcfcf; --accent:#ff7a18; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .bar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(180deg,var(--bar),#0c0c0c);border-bottom:1px solid var(--border)}
  .btn{background:#111;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border:0;color:#000;font-weight:900}
  .spacer{flex:1}
  .title{font-weight:900;letter-spacing:.2px}
  .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  iframe{display:block;width:100%;height:calc(100vh - 52px);border:0;background:#0c0c0c}
</style>
</head>
<body>
  <div class="bar">
    <button class="btn" id="backBtn">‚Üê Back</button>
    <div class="title" id="gameTitle">Loading‚Ä¶</div>
    <div class="spacer"></div>
    <div class="pill" title="Players currently in this game">üë• <span id="nowCount">0</span> Playing</div>
    <button class="btn" id="openBtn" title="Open game URL in a new tab">Open</button>
    <button class="btn primary" id="shareBtn" title="Copy share link">Share</button>
  </div>
  <iframe id="frame" sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms allow-popups allow-popups-to-escape-sandbox" referrerpolicy="no-referrer"></iframe>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getFirestore, doc, getDoc, onSnapshot, setDoc, serverTimestamp, collection, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBI7amPbyDP4cgtWvoooGz9JQAPXJEpCaE",
    authDomain: "buzzy-games.firebaseapp.com",
    projectId: "buzzy-games",
    storageBucket: "buzzy-games.firebasestorage.app",
    messagingSenderId: "1019717198169",
    appId: "1:1019717198169:web:8bff09527755e2672c6c48",
    measurementId: "G-JPPBF2PHDJ"
  };
  const app = initializeApp(firebaseConfig); try{ getAnalytics(app); }catch(e){}
  const db = getFirestore(app);

  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);
  const gameId = params.get('id');
  if(!gameId){ alert('Missing game id'); }

  const cutoffMs = () => Date.now() - 60_000;

  // stable per-browser session id
  const sessionId = (()=>{ let id=localStorage.getItem('bz_session'); if(!id){ id=crypto.getRandomValues(new Uint32Array(4)).join('-'); localStorage.setItem('bz_session', id);} return id; })();

  // site-wide presence heartbeat (so Analytics ‚Äúonline‚Äù stays accurate)
  const siteRef = doc(db, 'sitePresence', sessionId);
  setDoc(siteRef, { lastSeen: serverTimestamp() }, { merge:true });
  setInterval(()=> setDoc(siteRef, { lastSeen: serverTimestamp() }, { merge:true }), 25_000);

  // per-game presence heartbeat in top-level gameSessions (accurate)
  const sessKey = `${gameId}_${sessionId}`;
  const sessRef = doc(db, 'gameSessions', sessKey);
  setDoc(sessRef, { gameId, sessionId, lastSeen: serverTimestamp() }, { merge:true });
  setInterval(()=> setDoc(sessRef, { lastSeen: serverTimestamp() }, { merge:true }), 25_000);

  // Load game and wire UI
  const gRef = doc(db, 'games', gameId);
  const gSnap = await getDoc(gRef);
  if(gSnap.exists()){
    const g = gSnap.data();
    $('#gameTitle').textContent = g.name || 'Untitled';
    $('#frame').src = g.gameUrl;
    $('#openBtn').addEventListener('click', ()=> window.open(g.gameUrl, '_blank'));
    $('#shareBtn').addEventListener('click', async ()=>{
      const url = `${location.origin}${location.pathname}?id=${gameId}`;
      try{ await navigator.clipboard.writeText(url); alert('Share link copied!'); } catch{ prompt('Copy link:', url); }
    });
    // Count a play once per load (kept simple)
    try{ const { updateDoc, increment } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js'); await updateDoc(gRef, { plays: increment(1) }); }catch(e){}
  } else {
    $('#gameTitle').textContent = 'Game not found';
  }

  // Live "Playing" count ‚Äî listen to sessions for this game and filter by dynamic cutoff
  let latestDocs = [];
  onSnapshot(query(collection(db,'gameSessions'), where('gameId','==',gameId)), snap=>{
    latestDocs = snap.docs.map(d=>d.data());
    recomputeNow();
  });
  function recomputeNow(){
    const cutoff = cutoffMs();
    const n = latestDocs.reduce((acc,x)=>{
      const t = x.lastSeen;
      const ms = t?.toMillis ? t.toMillis() : (t?.seconds ? t.seconds*1000 : 0);
      return acc + (ms >= cutoff ? 1 : 0);
    }, 0);
    $('#nowCount').textContent = n;
  }
  setInterval(recomputeNow, 1000); // ensures stale sessions fall out visually

  // best-effort cleanup (optional; accuracy comes from cutoff anyway)
  window.addEventListener('pagehide', ()=>{ try{ navigator.sendBeacon('/', ''); }catch{} });
  $('#backBtn').addEventListener('click', ()=>{ if(document.referrer && document.referrer.includes(location.host)) history.back(); else location.href='index.html'; });
</script>
</body>
</html>
