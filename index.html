<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Nebula Launcher</title>
  <meta name="description" content="A sleek PWA game launcher with a Steam-like catalog." />

  <!-- App shell styles -->
  <style>
    :root{
      --bg:#0b0f14;
      --bg-elev:#111826;
      --bg-elev-2:#152033;
      --txt:#e6ebf5;
      --muted:#aab6ca;
      --accent:#5ac8fa;
      --accent-2:#8b5cf6;
      --chip:#1a2841;
      --card:#111a2b;
      --glass:rgba(255,255,255,0.04);
      --radius:18px;
      --shadow:0 8px 24px rgba(0,0,0,.3);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      color:var(--txt); background: radial-gradient(1200px 600px at 20% -10%, #152033, transparent 60%),
                         radial-gradient(1200px 800px at 110% 10%, #1c2a44, transparent 50%),
                         var(--bg);
      background-attachment: fixed;
    }
    a{color:inherit; text-decoration:none}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:14px;
      padding:14px 18px;
      background: linear-gradient(180deg, rgba(11,15,20,.9), rgba(11,15,20,.6));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px;
    }
    .logo{
      width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
      background: linear-gradient(140deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 16px rgba(90,200,250,.35);
      font-weight:900;
    }
    .nav{
      display:flex; gap:8px; margin-left:8px;
    }
    .nav button{
      background: transparent; color: var(--muted);
      border: 1px solid rgba(255,255,255,.08);
      padding:8px 12px; border-radius:12px; cursor:pointer;
    }
    .nav button.active{ color:var(--txt); border-color: rgba(255,255,255,.18); background:var(--glass)}
    .grow{flex:1}
    .search{
      display:flex; align-items:center; gap:8px; background:var(--bg-elev); border:1px solid rgba(255,255,255,.08);
      padding:8px 12px; border-radius:12px; width:min(440px, 50vw);
    }
    .search input{
      flex:1; border:none; background:transparent; color:var(--txt); outline:none; font-size:14px;
    }
    .actions{display:flex; gap:8px}
    .btn{
      background:linear-gradient(140deg, var(--accent), var(--accent-2));
      border:none; color:#08121f; font-weight:700; padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow:0 6px 16px rgba(90,200,250,.35);
    }
    .btn.secondary{
      background:transparent; color:var(--txt); border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }

    /* Layout */
    main{padding:22px; max-width:1200px; margin:0 auto;}
    section{margin-bottom:28px}
    .section-head{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;
    }
    .section-head h2{margin:0; font-size:20px; letter-spacing:.2px}
    .section-head .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      background:var(--chip); color:#d4def1; padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.08); cursor:pointer;
    }
    .row{
      display:grid; grid-auto-flow:column; grid-auto-columns: 200px;
      gap:14px; overflow-x:auto; padding-bottom:8px; scroll-snap-type:x mandatory;
    }
    .row::-webkit-scrollbar{height:10px}
    .row::-webkit-scrollbar-thumb{background:#27354f; border-radius:99px}

    .card{
      scroll-snap-align:start;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); overflow:hidden; position:relative; box-shadow: var(--shadow);
      display:flex; flex-direction:column; min-height:270px;
    }
    .cover{
      aspect-ratio:16/9; width:100%; background:#0e1626; position:relative; overflow:hidden;
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block}
    .badge{
      position:absolute; top:10px; left:10px;
      background:linear-gradient(140deg, #34d399, #10b981); color:#051019; font-weight:800;
      padding:6px 10px; border-radius:999px; font-size:11px; border:1px solid rgba(0,0,0,.1)
    }
    .content{padding:12px; display:flex; flex-direction:column; gap:8px}
    .title{font-weight:700; line-height:1.3}
    .genres{color:var(--muted); font-size:12px}
    .card .play{
      margin-top:auto; padding:8px 10px; display:flex; justify-content:space-between; align-items:center;
      background:rgba(255,255,255,.03); border-top:1px solid rgba(255,255,255,.06)
    }
    .ghost-btn{
      background:transparent; border:1px solid rgba(255,255,255,.12); color:var(--txt);
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }

    /* Modal */
    dialog{
      width:min(720px, 92vw); background:var(--bg-elev); color:var(--txt); border:1px solid rgba(255,255,255,.12);
      border-radius:20px; box-shadow:0 30px 60px rgba(0,0,0,.45); padding:0; overflow:hidden;
    }
    dialog::backdrop{background:rgba(0,0,0,.6); backdrop-filter: blur(4px)}
    .modal-head{display:flex; gap:14px; padding:16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-body{padding:16px; display:grid; gap:12px}
    .modal-actions{
      display:flex; justify-content:flex-end; gap:10px; padding:16px; border-top:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    }
    .pill{font-size:12px; background:var(--chip); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08)}
    .meta{display:flex; gap:8px; flex-wrap:wrap}
    .x{margin-left:auto; background:transparent; border:none; color:var(--muted); font-size:22px; cursor:pointer}

    /* Empty states */
    .empty{
      text-align:center; padding:40px 16px; color:var(--muted);
      border:1px dashed rgba(255,255,255,.12); border-radius:16px; background:rgba(255,255,255,.02)
    }

    /* Responsive tweaks */
    @media (max-width:720px){
      .search{width:auto}
      .row{grid-auto-columns: 72%}
    }
  </style>

  <script>
    // ---- Dynamic manifest with generated PNG icons (no extra file needed) ----
    (function setupDynamicManifest(){
      const makeIcon = (size) => {
        const c = document.createElement('canvas'); c.width = c.height = size;
        const ctx = c.getContext('2d');
        const g = ctx.createLinearGradient(0,0,size,size);
        g.addColorStop(0,'#5ac8fa'); g.addColorStop(1,'#8b5cf6');
        ctx.fillStyle = g; ctx.fillRect(0,0,size,size);
        // Subtle sparkle grid
        ctx.globalAlpha = .12; ctx.fillStyle = '#ffffff';
        for (let i=0;i<size;i+=Math.floor(size/8)){
          ctx.fillRect(i,0,1,size); ctx.fillRect(0,i,size,1);
        }
        ctx.globalAlpha = 1;
        // Logo glyph
        ctx.fillStyle = '#07121d';
        ctx.beginPath();
        const r = size*0.26;
        ctx.arc(size*0.5, size*0.5, r, 0, Math.PI*2);
        ctx.fill();
        // Inner dot
        ctx.fillStyle = '#5ac8fa';
        ctx.beginPath(); ctx.arc(size*0.5, size*0.5, r*0.35, 0, Math.PI*2); ctx.fill();
        return c.toDataURL('image/png');
      };
      const manifest = {
        name: "Nebula Launcher",
        short_name: "Nebula",
        start_url: ".",
        display: "standalone",
        background_color: "#0b0f14",
        theme_color: "#0b0f14",
        icons: [
          { src: makeIcon(192), sizes: "192x192", type: "image/png", purpose: "any" },
          { src: makeIcon(512), sizes: "512x512", type: "image/png", purpose: "any" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest'; link.href = url;
      document.head.appendChild(link);
    })();
  </script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">◎</div>
      <div>Nebula Launcher</div>
    </div>

    <nav class="nav">
      <button class="active" data-view="discover">Discover</button>
      <button data-view="library">Library</button>
    </nav>

    <div class="grow"></div>

    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M21 21l-3.5-3.5M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#aab6ca" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <input id="searchInput" placeholder="Search games…" />
    </div>

    <div class="actions">
      <button class="btn secondary" id="addGameBtn">Add Game</button>
      <button class="btn" id="installBtn">Install App</button>
    </div>
  </header>

  <main>
    <!-- Hero / New & Noteworthy -->
    <section id="newSection">
      <div class="section-head">
        <h2>New &amp; Noteworthy</h2>
        <button class="ghost-btn" id="viewAllNew">View all</button>
      </div>
      <div class="row" id="newRow"></div>
    </section>

    <!-- Genre Sections -->
    <section id="genresContainer"></section>

    <!-- Library View -->
    <section id="librarySection" hidden>
      <div class="section-head">
        <h2>Your Library</h2>
        <div class="chips">
          <span class="chip" data-lib-filter="all">All</span>
          <span class="chip" data-lib-filter="favorites">Favorites</span>
          <span class="chip" data-lib-filter="recent">Recently Played</span>
        </div>
      </div>
      <div id="libraryGrid" class="row"></div>
      <div class="empty" id="emptyLibrary" hidden>No games yet. Click <b>Add Game</b> to add your first title.</div>
    </section>
  </main>

  <!-- Game Modal -->
  <dialog id="gameModal">
    <div class="modal-head">
      <div style="width:140px; aspect-ratio:16/9; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08)">
        <img id="modalCover" alt="" style="width:100%; height:100%; object-fit:cover" />
      </div>
      <div style="display:flex; flex-direction:column; gap:6px; min-width:0; flex:1">
        <div style="display:flex; align-items:center; gap:10px;">
          <h3 id="modalTitle" style="margin:0"></h3>
          <button class="x" onclick="closeModal()" title="Close">&times;</button>
        </div>
        <div class="meta">
          <span id="modalGenres" class="pill"></span>
          <span id="modalRelease" class="pill"></span>
          <span id="modalUrl" class="pill" title="Launch URL"></span>
        </div>
      </div>
    </div>
    <div class="modal-body">
      <div id="modalDesc" style="color:var(--muted)"></div>
    </div>
    <div class="modal-actions">
      <button class="ghost-btn" id="favoriteBtn">★ Favorite</button>
      <button class="ghost-btn" id="libraryBtn">＋ Add to Library</button>
      <button class="btn" id="playBtn">Play</button>
    </div>
  </dialog>

  <!-- Add Game Modal -->
  <dialog id="addGameDialog">
    <form id="addGameForm" method="dialog" style="display:flex; flex-direction:column; gap:12px; padding:16px">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
        <h3 style="margin:0">Add a Game</h3>
        <button type="button" class="x" onclick="document.getElementById('addGameDialog').close()">&times;</button>
      </div>
      <div style="display:grid; gap:8px">
        <label>Title <input required name="title" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:var(--bg-elev); color:var(--txt)"></label>
        <label>Launch URL <input required name="url" placeholder="https://example.com/game" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:var(--bg-elev); color:var(--txt)"></label>
        <label>Genres (comma separated) <input name="genres" placeholder="Action, Strategy" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:var(--bg-elev); color:var(--txt)"></label>
        <label>Description <textarea name="description" rows="3" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:var(--bg-elev); color:var(--txt)"></textarea></label>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px">
        <button type="button" class="ghost-btn" onclick="document.getElementById('addGameDialog').close()">Cancel</button>
        <button class="btn">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // ----------------------- Data & Utils -----------------------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const STORAGE_KEYS = {
      LIB:'nebula.library',
      FAV:'nebula.favorites',
      PLAY:'nebula.played',
    };

    const defaultGames = [
      {
        id:'2048', title:'2048 Classic',
        url:'https://play2048.co',
        genres:['Puzzle','Casual'],
        release:'2025-06-01',
        description:'Slide tiles to combine numbers and reach 2048.',
      },
      {
        id:'wordle', title:'Wordle (NYT)',
        url:'https://www.nytimes.com/games/wordle/index.html',
        genres:['Puzzle','Casual'],
        release:'2025-05-10',
        description:'Guess the five-letter word in six tries.',
      },
      {
        id:'slope', title:'Slope',
        url:'https://kazioo.github.io/slope/',
        genres:['Action','Arcade'],
        release:'2025-07-21',
        description:'High-speed downhill arcade reflex challenge.',
      },
      {
        id:'chess', title:'Lichess',
        url:'https://lichess.org',
        genres:['Strategy','Board'],
        release:'2025-04-12',
        description:'Free online chess with puzzles & analysis.',
      },
      {
        id:'tetris', title:'Tetris JS',
        url:'https://chvin.github.io/react-tetris/',
        genres:['Arcade','Classic'],
        release:'2025-03-28',
        description:'A modern web take on the timeless classic.',
      },
      {
        id:'whg', title:'World’s Hardest Game',
        url:'https://snoaleen.github.io/whg/',
        genres:['Action','Classic'],
        release:'2025-05-30',
        description:'Dodge your way through brutal mazes.',
      },
      {
        id:'celeste', title:'Celeste Classic 2',
        url:'https://mattmakesgames.itch.io/celeste-classic-2',
        genres:['Platformer','Indie'],
        release:'2025-02-14',
        description:'A charming, challenging pico-8 platformer sequel.',
      },
      {
        id:'sudoku', title:'Sudoku',
        url:'https://sudokukingdom.com/',
        genres:['Puzzle','Board'],
        release:'2025-01-20',
        description:'Clean, daily sudoku with multiple difficulties.',
      },
    ].map(g=>({...g, cover: makeCover(g.title)}));

    function makeCover(title){
      // Generate an SVG cover with gradient & title, then encode as data URL
      const colors = [
        ['#5ac8fa','#8b5cf6'], ['#22d3ee','#06b6d4'],
        ['#34d399','#10b981'], ['#f472b6','#60a5fa'],
        ['#f59e0b','#f43f5e'], ['#a78bfa','#60a5fa'],
      ];
      const [c1,c2] = colors[Math.floor(Math.random()*colors.length)];
      const svg =
        `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='675'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0' stop-color='${c1}'/><stop offset='1' stop-color='${c2}'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <g fill='white' opacity='.12'>
            <circle cx='200' cy='120' r='90'/><circle cx='1050' cy='540' r='120'/>
            <rect x='0' y='620' width='1200' height='55'/>
          </g>
          <text x='52' y='560' font-family='Segoe UI, Roboto, Helvetica, Arial' font-weight='800' font-size='72' fill='rgba(255,255,255,.96)'>
            ${title.replace(/&/g,'&amp;')}
          </text>
        </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    const db = {
      get library(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.LIB) || '[]'); },
      set library(v){ localStorage.setItem(STORAGE_KEYS.LIB, JSON.stringify(v)); },
      get favorites(){ return new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.FAV) || '[]')); },
      set favorites(set){ localStorage.setItem(STORAGE_KEYS.FAV, JSON.stringify(Array.from(set))); },
      markPlayed(id){
        const dict = JSON.parse(localStorage.getItem(STORAGE_KEYS.PLAY) || '{}');
        dict[id] = Date.now();
        localStorage.setItem(STORAGE_KEYS.PLAY, JSON.stringify(dict));
      },
      getPlayed(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.PLAY) || '{}'); }
    };

    // Merge defaults into library (without duplicating)
    (function seedLibrary(){
      const lib = db.library;
      const ids = new Set(lib.map(g=>g.id));
      const merged = [...lib];
      defaultGames.forEach(g=>{ if(!ids.has(g.id)) merged.push(g); });
      db.library = merged;
    })();

    // ----------------------- Rendering -----------------------
    function render(){
      const q = $('#searchInput').value.trim().toLowerCase();
      const all = db.library.filter(g => !q || [g.title, ...(g.genres||[]), (g.description||'')].join(' ')
        .toLowerCase().includes(q));

      // New & Noteworthy: most recent 10 by release date
      const byDate = [...all].sort((a,b)=> new Date(b.release||0) - new Date(a.release||0));
      $('#newRow').innerHTML = byDate.slice(0,10).map(g=>cardHTML(g, true)).join('');

      // Genres
      const genres = Array.from(new Set(all.flatMap(g=>g.genres||[]))).sort();
      const container = $('#genresContainer');
      container.innerHTML = '';
      genres.forEach(genre=>{
        const items = all.filter(g=> (g.genres||[]).includes(genre));
        if(!items.length) return;
        const sec = document.createElement('div');
        sec.className = 'genre-sec';
        sec.innerHTML = `
          <div class="section-head">
            <h2>${genre}</h2>
            <button class="ghost-btn" data-view-genre="${genre}">View all</button>
          </div>
          <div class="row">${items.map(cardHTML).join('')}</div>
        `;
        container.appendChild(sec);
      });

      // Library view
      renderLibrary();
      attachCardEvents();
    }

    function cardHTML(g, showNewBadge=false){
      const genres = (g.genres||[]).slice(0,3).join(' • ');
      const newBadge = showNewBadge ? `<div class="badge">NEW</div>` : '';
      return `
      <article class="card" data-id="${g.id}">
        <div class="cover">
          <img alt="${escapeHtml(g.title)} cover" src="${g.cover}" loading="lazy"/>
          ${newBadge}
        </div>
        <div class="content">
          <div class="title">${escapeHtml(g.title)}</div>
          <div class="genres">${escapeHtml(genres)}</div>
        </div>
        <div class="play">
          <span style="color:var(--muted); font-size:12px">Quick actions</span>
          <div style="display:flex; gap:8px">
            <button class="ghost-btn" data-open="${g.id}">Details</button>
            <button class="ghost-btn" data-quickplay="${g.id}">Play</button>
          </div>
        </div>
      </article>`;
    }

    function renderLibrary(filter='all'){
      const favs = db.favorites;
      const played = db.getPlayed();
      let items = db.library;

      if(filter==='favorites') items = items.filter(g=>favs.has(g.id));
      if(filter==='recent'){
        items = items.filter(g=>played[g.id]).sort((a,b)=> (played[b.id]||0)-(played[a.id]||0));
      }
      $('#libraryGrid').innerHTML = items.map(cardHTML).join('');
      $('#emptyLibrary').hidden = items.length !== 0;
    }

    function attachCardEvents(){
      // Details & Quick Play
      $$('.card [data-open]').forEach(btn=>{
        btn.onclick = () => openGameModal(btn.getAttribute('data-open'));
      });
      $$('.card [data-quickplay]').forEach(btn=>{
        btn.onclick = () => quickPlay(btn.getAttribute('data-quickplay'));
      });
      // View-all by genre
      $$('[data-view-genre]').forEach(b=>{
        b.onclick = () => {
          switchView('library');
          $('#searchInput').value = b.getAttribute('data-view-genre');
          render();
        };
      });
    }

    function escapeHtml(s){ return s?.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) || ''; }

    // ----------------------- Modal & Actions -----------------------
    function openGameModal(id){
      const g = db.library.find(x=>x.id===id); if(!g) return;
      $('#modalCover').src = g.cover;
      $('#modalTitle').textContent = g.title;
      $('#modalGenres').textContent = (g.genres||[]).join(' • ') || '—';
      $('#modalRelease').textContent = `Released ${g.release || '—'}`;
      $('#modalUrl').textContent = new URL(g.url).host;
      $('#modalDesc').textContent = g.description || 'No description yet.';
      $('#favoriteBtn').onclick = () => toggleFavorite(g.id);
      $('#libraryBtn').onclick = () => addToLibrary(g);
      $('#playBtn').onclick = () => {
        db.markPlayed(g.id);
        window.open(g.url, '_blank', 'noopener,noreferrer');
      };
      $('#gameModal').showModal();
    }
    function closeModal(){ $('#gameModal').close(); }

    function quickPlay(id){
      const g = db.library.find(x=>x.id===id); if(!g) return;
      db.markPlayed(g.id);
      window.open(g.url, '_blank', 'noopener,noreferrer');
    }
    function toggleFavorite(id){
      const favs = db.favorites;
      if(favs.has(id)) favs.delete(id); else favs.add(id);
      db.favorites = favs;
      closeModal();
      renderLibrary(currentLibFilter); // refresh badges if you add later
    }
    function addToLibrary(g){
      const lib = db.library;
      if(!lib.find(x=>x.id===g.id)){
        db.library = [g, ...lib];
      }
      closeModal();
      switchView('library');
    }

    // ----------------------- Navigation & Search -----------------------
    let currentView = 'discover';
    function switchView(view){
      currentView = view;
      $$('.nav button').forEach(b => b.classList.toggle('active', b.dataset.view===view));
      $('#librarySection').hidden = view!=='library';
      $('#newSection').hidden = view!=='discover';
      $('#genresContainer').hidden = view!=='discover';
    }
    $('#viewAllNew').onclick = () => { switchView('library'); renderLibrary('recent'); };

    let currentLibFilter = 'all';
    $$('[data-lib-filter]').forEach(chip=>{
      chip.onclick = () => { currentLibFilter = chip.getAttribute('data-lib-filter'); renderLibrary(currentLibFilter); };
    });

    $('#searchInput').addEventListener('input', render);
    $$('[data-view]').forEach(btn => btn.onclick = () => switchView(btn.dataset.view));

    // ----------------------- Add Game -----------------------
    $('#addGameBtn').onclick = () => $('#addGameDialog').showModal();
    $('#addGameForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const title = String(fd.get('title')||'').trim();
      const url = String(fd.get('url')||'').trim();
      const genres = String(fd.get('genres')||'').split(',').map(s=>s.trim()).filter(Boolean);
      const description = String(fd.get('description')||'').trim();
      try{
        const u = new URL(url);
        if(!(u.protocol==='https:' || u.protocol==='http:')) throw new Error('Invalid URL');
      }catch{
        alert('Please enter a valid http(s) URL.'); return;
      }
      const id = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,40) || ('game-'+Date.now());
      const game = { id, title, url, genres, description, release: new Date().toISOString().slice(0,10), cover: makeCover(title) };
      db.library = [game, ...db.library]; // add to front
      $('#addGameDialog').close();
      switchView('library'); render();
    });

    // ----------------------- PWA Install -----------------------
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#installBtn').disabled = false;
    });
    $('#installBtn').onclick = async () => {
      if(!deferredPrompt){ alert('If your browser supports it, the install prompt will appear when ready.'); return; }
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    };

    // ----------------------- Service Worker -----------------------
    if('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.warn);
      });
    }

    // ----------------------- Init -----------------------
    render();
  </script>
</body>
</html>
