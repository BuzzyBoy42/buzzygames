<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="application-name" content="Buzzy Games Launcher" />
  <title>Buzzy Games Launcher</title>
  <meta name="description" content="A sleek, Steam-style PWA game launcher with a modern catalog UI." />

  <style>
    :root{
      --bg:#0b0f14; --bg-elev:#111826; --bg-elev-2:#152033;
      --txt:#e6ebf5; --muted:#aab6ca;
      --accent:#fbbf24; --accent-2:#8b5cf6;
      --chip:#1a2841; --card:#111a2b; --glass:rgba(255,255,255,0.04);
      --radius:18px; --shadow:0 8px 24px rgba(0,0,0,.3);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 20% -10%, #152033, transparent 60%),
                  radial-gradient(1200px 800px at 110% 10%, #1c2a44, transparent 50%),
                  var(--bg);
      background-attachment: fixed;
    }
    a{color:inherit; text-decoration:none}
    button[disabled]{opacity:.5; cursor:not-allowed}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:14px; padding:14px 18px;
      background: linear-gradient(180deg, rgba(11,15,20,.9), rgba(11,15,20,.6));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;}
    .logo{
      width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
      background: linear-gradient(140deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 16px rgba(251,191,36,.35); font-weight:900;
    }
    .grow{flex:1}
    .search{
      display:flex; align-items:center; gap:8px; background:var(--bg-elev); border:1px solid rgba(255,255,255,.08);
      padding:8px 12px; border-radius:12px; width:min(480px, 55vw);
    }
    .search input{ flex:1; border:none; background:transparent; color:var(--txt); outline:none; font-size:14px; }
    .btn{
      background:linear-gradient(140deg, var(--accent), var(--accent-2));
      border:none; color:#08121f; font-weight:700; padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow:0 6px 16px rgba(251,191,36,.35);
    }
    .btn.secondary{ background:transparent; color:var(--txt); border:1px solid rgba(255,255,255,.12); box-shadow:none; }
    .btn.small{ padding:8px 12px; border-radius:10px; font-size:13px; }
    .ghost-btn{
      background:transparent; border:1px solid rgba(255,255,255,.12); color:var(--txt);
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }

    /* Install banner (recommended) */
    .install-banner{
      display:flex; align-items:center; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 16px;
    }
    .install-banner .note{ color:var(--muted); font-size:14px }
    .install-banner .actions{ margin-left:auto; display:flex; gap:8px }

    main{padding:22px; max-width:1200px; margin:0 auto;}
    section{margin-bottom:28px}
    .section-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .section-head h2{margin:0; font-size:20px; letter-spacing:.2px}
    .row{
      display:grid; grid-auto-flow:column; grid-auto-columns: 220px;
      gap:14px; overflow-x:auto; padding-bottom:8px; scroll-snap-type:x mandatory;
    }
    .row::-webkit-scrollbar{height:10px}
    .row::-webkit-scrollbar-thumb{background:#27354f; border-radius:99px}

    .card{
      scroll-snap-align:start;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius); overflow:hidden; position:relative; box-shadow: var(--shadow);
      display:flex; flex-direction:column; min-height:300px;
    }
    .cover{ aspect-ratio:16/9; width:100%; background:#0e1626; position:relative; overflow:hidden; }
    .cover img{width:100%; height:100%; object-fit:cover; display:block}
    .badge{
      position:absolute; top:10px; left:10px;
      background:linear-gradient(140deg, #34d399, #10b981); color:#051019; font-weight:800;
      padding:6px 10px; border-radius:999px; font-size:11px; border:1px solid rgba(0,0,0,.1)
    }
    .content{padding:12px; display:flex; flex-direction:column; gap:8px}
    .title{font-weight:800; line-height:1.3}
    .genres{color:var(--muted); font-size:12px}
    .desc{ color:var(--muted); font-size:12px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

    /* Dialogs */
    dialog{
      width:min(720px, 92vw); background:var(--bg-elev); color:var(--txt); border:1px solid rgba(255,255,255,.12);
      border-radius:20px; box-shadow:0 30px 60px rgba(0,0,0,.45); padding:0; overflow:hidden;
    }
    dialog::backdrop{background:rgba(0,0,0,.6); backdrop-filter: blur(4px)}
    .modal-head{display:flex; gap:14px; padding:16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-body{padding:16px; display:grid; gap:12px}
    .modal-actions{
      display:flex; justify-content:flex-end; gap:10px; padding:16px; border-top:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    }
    .pill{font-size:12px; background:var(--chip); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08)}
    .meta{display:flex; gap:8px; flex-wrap:wrap}
    .x{margin-left:auto; background:transparent; border:none; color:var(--muted); font-size:22px; cursor:pointer}

    @media (max-width:720px){
      .search{width:auto}
      .row{grid-auto-columns: 78%}
    }

    /* Toast */
    .toast {
      position: fixed; inset: auto 16px 16px auto;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px; padding: 10px 12px; font-size: 13px; color: var(--muted);
      backdrop-filter: blur(6px); display: none; z-index: 1000;
    }
    .toast.show { display: block; }
  </style>

  <script>
    /* -------- Dynamic manifest (no extra file needed) -------- */
    (function setupDynamicManifest(){
      const makeIcon = (size) => {
        const c = document.createElement('canvas'); c.width = c.height = size;
        const ctx = c.getContext('2d');
        const g = ctx.createLinearGradient(0,0,size,size);
        g.addColorStop(0,'#fbbf24'); g.addColorStop(1,'#8b5cf6');
        ctx.fillStyle = g; ctx.fillRect(0,0,size,size);
        ctx.globalAlpha = .12; ctx.fillStyle = '#ffffff';
        for (let i=0;i<size;i+=Math.floor(size/8)){ ctx.fillRect(i,0,1,size); ctx.fillRect(0,i,size,1); }
        ctx.globalAlpha = 1;
        ctx.fillStyle = '#07121d'; ctx.beginPath(); ctx.arc(size*0.5, size*0.5, size*0.26, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(size*0.5, size*0.5, size*0.09, 0, Math.PI*2); ctx.fill();
        return c.toDataURL('image/png');
      };

      const icon192 = makeIcon(192);
      const icon512 = makeIcon(512);

      const apple = document.createElement('link');
      apple.rel = 'apple-touch-icon';
      apple.href = icon192;
      document.head.appendChild(apple);

      const manifest = {
        id: "/?source=pwa",
        name: "Buzzy Games Launcher",
        short_name: "Buzzy Games",
        start_url: ".",
        scope: ".",
        display: "standalone",
        background_color: "#0b0f14",
        theme_color: "#0b0f14",
        icons: [
          { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
          { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest'; link.href = url;
      document.head.appendChild(link);
    })();
  </script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">üêù</div>
      <div>Buzzy Games Launcher</div>
    </div>

    <div class="grow"></div>

    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M21 21l-3.5-3.5M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#aab6ca" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <input id="searchInput" placeholder="Search games‚Ä¶" />
    </div>

    <button class="btn" id="installBtn" title="Recommended">Install App</button>
  </header>

  <!-- Soft recommendation banner (non-blocking) -->
  <div class="install-banner" id="installBanner" hidden>
    <div class="note">For the best experience, <b>install Buzzy Games</b> (recommended).</div>
    <div class="actions">
      <button class="btn small" id="bannerInstallBtn">Install</button>
      <button class="ghost-btn small" id="bannerDismissBtn">Dismiss</button>
    </div>
  </div>

  <main>
    <section id="newSection">
      <div class="section-head">
        <h2>New &amp; Noteworthy</h2>
        <div style="opacity:.75;font-size:12px">Fresh picks from the catalog</div>
      </div>
      <div class="row" id="newRow"></div>
    </section>

    <section id="genresContainer"></section>
  </main>

  <!-- Game Details Modal -->
  <dialog id="gameModal">
    <div class="modal-head">
      <div style="width:140px; aspect-ratio:16/9; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08)">
        <img id="modalCover" alt="" style="width:100%; height:100%; object-fit:cover" />
      </div>
      <div style="display:flex; flex-direction:column; gap:6px; min-width:0; flex:1">
        <div style="display:flex; align-items:center; gap:10px;">
          <h3 id="modalTitle" style="margin:0"></h3>
          <button class="x" onclick="closeModal()" title="Close">&times;</button>
        </div>
        <div class="meta">
          <span id="modalGenres" class="pill"></span>
          <span id="modalRelease" class="pill"></span>
          <span id="modalUrl" class="pill" title="Launch URL"></span>
        </div>
      </div>
    </div>
    <div class="modal-body">
      <div id="modalDesc" style="color:var(--muted)"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="playBtn">Play</button>
    </div>
  </dialog>

  <!-- Update Available Modal -->
  <dialog id="updateDialog">
    <div class="modal-head">
      <div style="display:flex;align-items:center;gap:10px;min-width:0;flex:1">
        <h3 style="margin:0">New update available</h3>
        <button class="x" id="updCloseBtn" title="Close">&times;</button>
      </div>
    </div>
    <div class="modal-body">
      <div style="color:var(--muted)">A new deployment of <b>Buzzy Games Launcher</b> is available.</div>
      <div class="meta" style="margin-top:6px">
        <span id="updVersion" class="pill">Version ‚Äì</span>
        <span id="updSize" class="pill">Size ‚Äì</span>
        <span id="updSource" class="pill">Source ‚Äì</span>
      </div>
      <div id="updNote" style="font-size:13px;color:var(--muted)">
        Click <b>Download &amp; Replace</b> to save the new ZIP and overwrite your existing copy.
      </div>
      <div id="updCompat" style="font-size:12px;color:var(--muted)">
        Tip: On Chrome/Edge you can overwrite the same file. On Safari/Firefox you'll just download a new ZIP.
      </div>
      <div id="updStatus" style="font-size:12px;color:var(--muted)"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="updDownloadBtn">Download &amp; Replace</button>
      <button class="btn secondary" id="updPickBtn" title="Choose a different file to overwrite">Choose File‚Ä¶</button>
      <button class="ghost-btn" id="updLaterBtn">Later</button>
    </div>
  </dialog>

  <!-- Checking toast -->
  <div id="updateToast" class="toast">Checking for updates‚Ä¶</div>

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    /* ---------------- Catalog ---------------- */
    const catalog = [
      { title:'2048', url:'https://www.mathsisfun.com/games/a/2048/index.html',
        image:'https://plays.org/wp-content/uploads/2048-game.png',
        description:'Slide tiles to combine numbers and reach 2048.',
        genres:['Puzzle','Casual'], release:'2025-09-08' },

      { title:'[DOWN] Slope', url:'https://kdata1.com/2020/05/slope/',
        image:'https://th.bing.com/th/id/R.a1698336509a355d218f5f4211f345d0?rik=ae%2ft9J6scxY7ow&pid=ImgRaw&r=0',
        description:'High-speed downhill reflex challenge with neon vibes.',
        genres:['Action','Arcade'], release:'2025-09-08' },

      { title:'Snow Rider 3D', url:'https://www.hoodamath.com/mobile/games/snow-rider-3d/game.html?nocheckorient=1',
        image:'https://www.hoodamath.com/large/snowrider3d_300x225.jpg',
        description:'Sled to get the highest score.',
        genres:['Action','Strategic'], release:'2025-09-08' },

      { title:'[DOWN] Drive Mad', url:'https://mathplayzone.com/wp-content/uploads/assets/drive-mad/',
        image:'https://tse1.mm.bing.net/th/id/OIP.odp26kFzqu9k2p8kmeAJGgHaHa?r=0&cb=thfc1ucfimg=1&rs=1&pid=ImgDetMain&o=7&rm=3',
        description:'Complete levels and drive your way up.',
        genres:['Action','Strategic'], release:'2025-09-08' },

      { title:'Eggy Car', url:'https://webglmath.github.io/eggy-car/',
        image:'https://eggycar.co/data/image/image.png',
        description:'Dont let your egg break.',
        genres:['Action','Strategic'], release:'2025-09-08' },
      
      { title:'Eggy Car', url:'https://webglmath.github.io/eggy-car/',
        image:'https://eggycar.co/data/image/image.png',
        description:'Dont let your egg break.',
        genres:['Action','Strategic'], release:'2025-09-08' },
    ].map((g,i)=>({ id: (g.title.toLowerCase().replace(/[^a-z0-9]+/g,'-')||`game-${i}`), ...g }));

    /* ---------------- Install UI (recommended only) ---------------- */
    const LS_INSTALLED = 'buzzy.installed';
    const LS_BANNER_DISMISSED = 'buzzy.installBannerDismissed';
    let deferredPrompt = null;

    function isInstalled() {
      return window.matchMedia('(display-mode: standalone)').matches
          || window.navigator.standalone === true
          || document.referrer.startsWith('android-app://')
          || JSON.parse(localStorage.getItem(LS_INSTALLED) || 'false');
    }
    let installed = isInstalled();

    function setInstalled(v){
      installed = !!v;
      localStorage.setItem(LS_INSTALLED, JSON.stringify(installed));
      updateInstallUI();
    }

    function updateInstallUI(){
      $('#installBtn').style.display = installed ? 'none' : '';
      const dismissed = JSON.parse(localStorage.getItem(LS_BANNER_DISMISSED) || 'false');
      $('#installBanner').hidden = installed || dismissed;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#installBtn').disabled = false;
    });
    window.addEventListener('appinstalled', () => setInstalled(true));

    $('#installBtn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        if (choice.outcome === 'accepted') setInstalled(true);
        deferredPrompt = null;
      } else {
        alert(installHelpText());
      }
    };
    $('#bannerInstallBtn').onclick = () => $('#installBtn').click();
    $('#bannerDismissBtn').onclick = () => {
      localStorage.setItem(LS_BANNER_DISMISSED, 'true');
      updateInstallUI();
    };
    function installHelpText(){
      const ua = navigator.userAgent.toLowerCase();
      if (/iphone|ipad|ipod/.test(ua)) return 'On iPhone/iPad: Share ‚Üí Add to Home Screen.';
      if (/android/.test(ua)) return 'On Android Chrome: ‚ãÆ menu ‚Üí Install app (or Add to Home screen).';
      return 'On desktop Chrome/Edge: Click the Install icon in the address bar, or use the browser menu.';
    }

    /* ---------------- Render ---------------- */
    const escapeHtml = (s) => s?.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) || '';
    function makeCoverFallback(title){
      const colors = [
        ['#fbbf24','#8b5cf6'], ['#22d3ee','#06b6d4'],
        ['#34d399','#10b981'], ['#f472b6','#60a5fa'],
        ['#f59e0b','#f43f5e'], ['#a78bfa','#60a5fa'],
      ];
      const [c1,c2] = colors[Math.floor(Math.random()*colors.length)];
      const svg =
        `<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='675'>
          <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
            <stop offset='0' stop-color='${c1}'/><stop offset='1' stop-color='${c2}'/>
          </linearGradient></defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <g fill='white' opacity='.12'>
            <circle cx='200' cy='120' r='90'/><circle cx='1050' cy='540' r='120'/>
            <rect x='0' y='620' width='1200' height='55'/>
          </g>
          <text x='52' y='560' font-family='Segoe UI, Roboto, Helvetica, Arial' font-weight='800' font-size='72' fill='rgba(255,255,255,.96)'>
            ${title.replace(/&/g,'&amp;')}
          </text>
        </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function cardHTML(g, showNewBadge=false){
      const genres = (g.genres||[]).slice(0,3).join(' ‚Ä¢ ');
      const newBadge = showNewBadge ? `<div class="badge">NEW</div>` : '';
      return `
      <article class="card" data-id="${g.id}">
        <div class="cover">
          <img alt="${escapeHtml(g.title)} cover" src="${g.image || ''}" onerror="this.src='${makeCoverFallback(g.title)}'" loading="lazy"/>
          ${newBadge}
        </div>
        <div class="content">
          <div class="title">${escapeHtml(g.title)}</div>
          <div class="genres">${escapeHtml(genres)}</div>
          <div class="desc">${escapeHtml(g.description||'')}</div>
        </div>
      </article>`;
    }

    function render(){
      const q = $('#searchInput').value.trim().toLowerCase();
      const all = catalog.filter(g => !q || [g.title, ...(g.genres||[]), (g.description||'')].join(' ')
        .toLowerCase().includes(q));

      const byDate = [...all].sort((a,b)=> new Date(b.release||0) - new Date(a.release||0));
      $('#newRow').innerHTML = byDate.slice(0,10).map(g=>cardHTML(g,true)).join('');

      const genres = Array.from(new Set(all.flatMap(g=>g.genres||[]))).sort();
      const container = $('#genresContainer'); container.innerHTML = '';
      genres.forEach(genre=>{
        const items = all.filter(g=> (g.genres||[]).includes(genre));
        if(!items.length) return;
        const sec = document.createElement('section');
        sec.innerHTML = `
          <div class="section-head"><h2>${genre}</h2></div>
          <div class="row">${items.map(cardHTML).join('')}</div>
        `;
        container.appendChild(sec);
      });

      attachCardEvents();
      updateInstallUI();
    }

    function attachCardEvents(){
      $$('.card').forEach(card=>{
        card.onclick = () => openGameModal(card.getAttribute('data-id'));
      });
    }

    /* ---------------- Modal & Play ---------------- */
    function openGameModal(id){
      const g = catalog.find(x=>x.id===id); if(!g) return;
      $('#modalCover').src = g.image || makeCoverFallback(g.title);
      $('#modalTitle').textContent = g.title;
      $('#modalGenres').textContent = (g.genres||[]).join(' ‚Ä¢ ') || '‚Äî';
      $('#modalRelease').textContent = `Released ${g.release || '‚Äî'}`;
      try{ $('#modalUrl').textContent = new URL(g.url).host; }catch{ $('#modalUrl').textContent = g.url; }
      $('#modalDesc').textContent = g.description || 'No description yet.';
      $('#playBtn').onclick = () => {
        const q = new URLSearchParams({ url: g.url, title: g.title, image: g.image || '', desc: g.description || '' });
        location.href = `./embed.html?${q.toString()}`;
      };
      $('#gameModal').showModal();
    }
    function closeModal(){ $('#gameModal').close(); }

    /* ---------------- PWA SW ---------------- */
    if('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.warn);
      });
    }

    /* ---------------- AUTO-UPDATE (ZIP download & replace) ---------------- */
    const GH_REPO = 'BuzzyBoy42/buzzygames';
    const LS_REV = 'buzzy.revision';
    const LS_LAST_CHECK = 'buzzy.revCheckedAt';
    const CHECK_INTERVAL_MS = 6 * 60 * 60 * 1000;

    const toast = $('#updateToast');
    const updDlg = $('#updateDialog');
    const updVersion = $('#updVersion');
    const updSize = $('#updSize');
    const updSource = $('#updSource');
    const updStatus = $('#updStatus');
    const btnDownload = $('#updDownloadBtn');
    const btnPick = $('#updPickBtn');
    const btnClose = $('#updCloseBtn');
    const btnLater = $('#updLaterBtn');

    function showToast(msg){ if (toast){ toast.textContent = msg; toast.classList.add('show'); } }
    function hideToast(){ toast?.classList.remove('show'); }

    // (Optional) to avoid rate limits / access private repos, set a token once in DevTools:
    // localStorage.setItem('buzzy.ghToken', 'ghp_...')
    function ghHeaders(extra={}) {
      const h = { 'Accept': 'application/vnd.github+json', ...extra };
      const t = (localStorage.getItem('buzzy.ghToken')||'').trim();
      if (t) h['Authorization'] = `Bearer ${t}`;
      return h;
    }

    async function latestReleaseMeta(){
      const r = await fetch(`https://api.github.com/repos/${GH_REPO}/releases/latest`, {
        headers: ghHeaders(), cache:'no-store'
      });
      if (!r.ok) throw new Error(`releases/latest: ${r.status}`);
      const j = await r.json();

      let zipUrl = null, size = 0;
      if (Array.isArray(j.assets) && j.assets.length){
        const asset = j.assets.find(a => /zip$/i.test(a.browser_download_url)) || j.assets[0];
        zipUrl = asset.browser_download_url; size = asset.size || 0;
      } else {
        zipUrl = j.zipball_url; // redirects to codeload
      }
      return {
        source: 'Release',
        version: j.tag_name || (j.name || '').trim() || (j.published_at || '').slice(0,10),
        zipUrl, size
      };
    }

    async function latestCommitMeta(){
      const r = await fetch(`https://api.github.com/repos/${GH_REPO}/commits/main`, {
        headers: ghHeaders(), cache:'no-store'
      });
      if (!r.ok) throw new Error(`commits/main: ${r.status}`);
      const j = await r.json();
      const sha = (j.sha || '').slice(0,7);
      const zipUrl = `https://github.com/${GH_REPO}/archive/refs/heads/main.zip`;

      let size = 0;
      try {
        const head = await fetch(zipUrl, { method:'HEAD', cache:'no-store' });
        const len = head.headers.get('content-length');
        if (len) size = +len;
      } catch {}
      return { source:'Commit', version: sha, zipUrl, size };
    }

    async function getLatestMeta(){
      try { return await latestReleaseMeta(); }
      catch { return await latestCommitMeta(); }
    }

    function humanSize(bytes){
      if (!bytes || isNaN(bytes)) return '‚Äî';
      const units=['B','KB','MB','GB']; let i=0; let n=bytes;
      while(n>=1024 && i<units.length-1){ n/=1024; i++; }
      return `${n.toFixed(n>=10||i<2?0:1)} ${units[i]}`;
    }

    // Minimal IndexedDB KV to store the chosen ZIP FileSystemFileHandle
    const idb = {
      db: null,
      async open(){
        if (this.db) return this.db;
        this.db = await new Promise((res,rej)=>{
          const req = indexedDB.open('buzzyFS',1);
          req.onupgradeneeded = () => req.result.createObjectStore('kv');
          req.onsuccess = () => res(req.result);
          req.onerror = () => rej(req.error);
        });
        return this.db;
      },
      async get(key){
        const db = await this.open();
        return new Promise((res,rej)=>{
          const tx = db.transaction('kv','readonly').objectStore('kv').get(key);
          tx.onsuccess = () => res(tx.result || null);
          tx.onerror = () => rej(tx.error);
        });
      },
      async set(key,val){
        const db = await this.open();
        return new Promise((res,rej)=>{
          const tx = db.transaction('kv','readwrite').objectStore('kv').put(val, key);
          tx.onsuccess = () => res(true);
          tx.onerror = () => rej(tx.error);
        });
      }
    };

    async function verifyPermission(handle, rw=true){
      if (!handle) return false;
      const opts = { mode: rw ? 'readwrite' : 'read' };
      try {
        if (await handle.queryPermission(opts) === 'granted') return true;
        return (await handle.requestPermission(opts)) === 'granted';
      } catch { return false; }
    }

    async function pickExistingZip(){
      if (!window.showOpenFilePicker) return null;
      const [h] = await window.showOpenFilePicker({
        multiple:false,
        types:[{ description:'ZIP files', accept:{'application/zip':['.zip']} }]
      });
      return h || null;
    }

    async function pickSaveZip(suggestedName='BuzzyGamesLauncher.zip'){
      if (!window.showSaveFilePicker) return null;
      return await window.showSaveFilePicker({
        suggestedName,
        types:[{ description:'ZIP file', accept:{'application/zip':['.zip']} }]
      });
    }

    async function streamToBlob(url){
      const r = await fetch(url, { cache:'no-store', redirect:'follow' });
      if (!r.ok) {
        const rem = r.headers.get('x-ratelimit-remaining');
        const why = r.status===403 && rem==='0' ? 'GitHub rate limit reached' : `HTTP ${r.status}`;
        throw new Error(`Download failed (${why})`);
      }
      return await r.blob();
    }

    async function writeBlobToHandle(handle, blob){
      const w = await handle.createWritable();
      await w.write(blob);
      await w.close();
    }

    function directDownload(url){
      const a = document.createElement('a');
      a.href = url; a.download = ''; a.rel='noopener';
      document.body.appendChild(a); a.click(); a.remove();
    }

    function setDialog(meta){
      updVersion.textContent = `Version ${meta.version || '‚Äî'}`;
      updSize.textContent = `Size ${humanSize(meta.size)}`;
      updSource.textContent = `Source ${meta.source}`;
      updDlg.dataset.zipUrl = meta.zipUrl;
      updDlg.dataset.version = meta.version;
    }

    async function ensureUpToDate(force=false){
      const last = +(localStorage.getItem(LS_LAST_CHECK) || 0);
      if (!force && (Date.now() - last) < CHECK_INTERVAL_MS) return;
      localStorage.setItem(LS_LAST_CHECK, String(Date.now()));
      showToast('Checking for updates‚Ä¶');
      try{
        const meta = await getLatestMeta();
        const current = localStorage.getItem(LS_REV) || '';
        if (meta.version && meta.version !== current){
          setDialog(meta);
          updStatus.textContent = '';
          updDlg.showModal();
        }
      }catch(e){
        console.warn('Update check failed:', e);
        showToast(`Update check failed: ${e.message}`);
        setTimeout(hideToast, 2500);
      }finally{
        hideToast();
      }
    }

    // Dialog wiring
    btnClose.onclick = () => updDlg.close();
    btnLater.onclick = () => updDlg.close();

    $('#updPickBtn').onclick = async ()=>{
      try{
        const picked = await pickExistingZip() || await pickSaveZip();
        if (picked){ await idb.set('zipHandle', picked); updStatus.textContent = 'Location saved.'; }
      }catch(e){ updStatus.textContent = `No file selected (${e && e.message || 'cancelled'})`; }
    };

    btnDownload.onclick = async ()=>{
      btnDownload.disabled = true; btnPick.disabled = true;
      const zipUrl = updDlg.dataset.zipUrl;
      const ver = updDlg.dataset.version;
      updStatus.textContent = 'Downloading‚Ä¶';
      try{
        const blob = await streamToBlob(zipUrl);

        let storedHandle = await idb.get('zipHandle');

        // If we have a remembered handle, try to overwrite it
        if (storedHandle && window.showSaveFilePicker){
          const ok = await verifyPermission(storedHandle, true);
          if (ok){
            await writeBlobToHandle(storedHandle, blob);
            updStatus.textContent = 'Replaced existing ZIP.';
            localStorage.setItem(LS_REV, ver);
            setTimeout(()=>updDlg.close(), 700);
            btnDownload.disabled = false; btnPick.disabled = false;
            return;
          }
        }

        // Otherwise, ask where to save; remember for next time
        if (window.showSaveFilePicker){
          const h = await pickSaveZip();
          if (h){
            await writeBlobToHandle(h, blob);
            await idb.set('zipHandle', h);
            updStatus.textContent = 'Saved. Will overwrite this file next time.';
            localStorage.setItem(LS_REV, ver);
            setTimeout(()=>updDlg.close(), 700);
            btnDownload.disabled = false; btnPick.disabled = false;
            return;
          }
        }

        // Fallback (Safari/Firefox or file://): normal download, manual replace
        directDownload(zipUrl);
        updStatus.textContent = 'Downloaded. Replace your old ZIP manually.';
        localStorage.setItem(LS_REV, ver);
        setTimeout(()=>updDlg.close(), 1200);
      }catch(e){
        console.error(e);
        updStatus.textContent = `Update failed: ${e && e.message || e}`;
      }finally{
        btnDownload.disabled = false; btnPick.disabled = false;
      }
    };

    // Kick off checks
    (async () => {
      ensureUpToDate(true);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) ensureUpToDate(false); });
      setInterval(()=> ensureUpToDate(false), CHECK_INTERVAL_MS);

      // Debug shortcut: Shift+U to force a check
      window.addEventListener('keydown', (ev)=>{
        if (ev.shiftKey && (ev.key==='U' || ev.key==='u')) ensureUpToDate(true);
      });
    })();
    /* ---------------- END AUTO-UPDATE ---------------- */

    // Init UI
    $('#searchInput').addEventListener('input', render);
    render();
  </script>
</body>
</html>
